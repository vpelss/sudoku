<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">

<html>
  <head><script type="text/javascript" src="/static/js/analytics.js?v=1504952612.0" charset="utf-8"></script>

<script type="text/javascript">archive_analytics.values.service='wb';archive_analytics.values.server_name='wwwb-app29.us.archive.org';archive_analytics.values.server_ms=731;</script><script type="text/javascript" src="/static/js/wbhack.js?v=1504952612.0" charset="utf-8"></script>

<script type="text/javascript">
__wbhack.init('https://web.archive.org/web');
</script>
<link rel="stylesheet" type="text/css" href="/static/css/banner-styles.css?v=1504952612.0" />
<link rel="stylesheet" type="text/css" href="/static/css/iconochive.css?v=1504952612.0" />

<!-- End Wayback Rewrite JS Include -->
    <title>Obfuscation as a learning tool.</title>
    <link href="/web/20060426135849cs_/http://www.ecclestoad.co.uk:80/main.css" rel="stylesheet" type="text/css">
    <link rel="alternate" type="application/rss+xml" title="Edmund von der Burg's blog" href="https://web.archive.org/web/20060426135849/http://www.ecclestoad.co.uk/blog/rss.xml"/>

    
  </head>
  <body><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script type="text/javascript" src="/static/js/timestamp.js?v=1504952612.0" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/graph-calc.js?v=1504952612.0" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/auto-complete.js?v=1504952612.0" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/toolbar.js?v=1504952612.0" charset="utf-8"></script>

<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  /*min-width:800px !important;*/
}
.wb-autocomplete-suggestions {
    text-align: left; cursor: default; border: 1px solid #ccc; border-top: 0; background: #fff; box-shadow: -1px 1px 3px rgba(0,0,0,.1);
    position: absolute; display: none; z-index: 2147483647; max-height: 254px; overflow: hidden; overflow-y: auto; box-sizing: border-box;
}
.wb-autocomplete-suggestion { position: relative; padding: 0 .6em; line-height: 23px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.02em; color: #333; }
.wb-autocomplete-suggestion b { font-weight: bold; }
.wb-autocomplete-suggestion.selected { background: #f0f0f0; }
</style>
<div id="wm-ipp" lang="en" style="display:none;direction:ltr;">
<div style="position:fixed;left:0;top:0;right:0;">
<div id="wm-ipp-inside">
  <div style="position:relative;">
    <div id="wm-logo" style="float:left;width:130px;padding-top:10px;">
      <a href="/web/" title="Wayback Machine home page"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0" /></a>
    </div>
    <div class="r" style="float:right;">
      <div id="wm-btns" style="text-align:right;height:25px;">
	<a href="http://faq.web.archive.org/" title="Get some help using the Wayback Machine" style="top:-5px;"><span class="iconochive-question" style="color:rgb(87,186,244);font-size:160%;"></span></a>
	<a id="wm-tb-close" href="#close" onclick="__wm.h(event);return false;" style="top:-2px;" title="Close the toolbar"><span class="iconochive-remove-circle" style="color:#888888;font-size:240%;"></span></a>
      </div>
      <div id="wm-share" style="text-align:right;">
	<a href="#" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=https://web.archive.org/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html', '', 'height=400,width=600'); return false;" title="Share on Facebook" style="margin-right:5px;" target="_blank"><span class="iconochive-facebook" style="color:#3b5998;font-size:160%;"></span></a>
	<a href="#" onclick="window.open('https://twitter.com/intent/tweet?text=https://web.archive.org/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html&amp;via=internetarchive', '', 'height=400,width=600'); return false;" title="Share on Twitter" style="margin-right:5px;" target="_blank"><span class="iconochive-twitter" style="color:#1dcaff;font-size:160%;"></span></a>
      </div>
    </div>
    <table class="c" style="">
      <tbody>
	<tr>
	  <td class="u" colspan="2">
	    <form target="_top" method="get" action="/web/submit" name="wmtb" id="wmtb"><input type="text" name="url" id="wmtbURL" value="http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html" onfocus="this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20060426135849" /><input type="submit" value="Go" /></form>
	  </td>
	  <td class="n" rowspan="2" style="width:110px;">
	    <table>
	      <tbody>
		<!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
		<tr class="m">
		  <td class="b" nowrap="nowrap"><a href="https://web.archive.org/web/20060226194637/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html" title="26 Feb 2006"><strong>Feb</strong></a></td>
		  <td class="c" id="displayMonthEl" title="You are here: 13:58:49 Apr 26, 2006">APR</td>
		  <td class="f" nowrap="nowrap"><a href="https://web.archive.org/web/20060618000951/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html" title="18 Jun 2006"><strong>Jun</strong></a></td>
		</tr>
		<!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
		<tr class="d">
		  <td class="b" nowrap="nowrap"><a href="https://web.archive.org/web/20060226194637/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html" title="19:46:37 Feb 26, 2006"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a></td>
		  <td class="c" id="displayDayEl" style="width:34px;font-size:24px;" title="You are here: 13:58:49 Apr 26, 2006">26</td>
		  <td class="f" nowrap="nowrap"><a href="https://web.archive.org/web/20060618000951/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html" title="00:09:51 Jun 18, 2006"><img src="/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0" /></a></td>
		</tr>
		<!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
		<tr class="y">
		  <td class="b" nowrap="nowrap">2005</td>
		  <td class="c" id="displayYearEl" title="You are here: 13:58:49 Apr 26, 2006">2006</td>
		  <td class="f" nowrap="nowrap"><a href="https://web.archive.org/web/20070608124030/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html" title="08 Jun 2007"><strong>2007</strong></a></td>
		</tr>
	      </tbody>
	    </table>
	  </td>
	</tr>
	<tr>
	  <td class="s">
	    	    <div id="wm-nav-captures">
	      	      <a class="t" href="/web/20060426135849*/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html" title="See a list of every capture for this URL">28 captures</a>
	      <div class="r" title="Timespan for captures of this URL">26 Feb 2006 - 05 Jun 2013</div>
	      </div>
	  </td>
	  <td class="k">
	    <a href="" id="wm-graph-anchor">
	      <div id="wm-ipp-sparkline" title="Explore captures for this URL" style="position: relative">
		<canvas id="wm-sparkline-canvas" width="550" height="27" border="0"></canvas>
	      </div>
	    </a>
	  </td>
	</tr>
      </tbody>
    </table>
    <div style="position:absolute;bottom:0;right:2px;text-align:right;">
      <a id="wm-expand" class="wm-btn" href="#expand" onclick="__wm.ex(event);return false;"><span class="iconochive-down-solid"></span> <span style="font-size:80%">About this capture</span></a>
    </div>
  </div>
    <div id="wm-capinfo" style="border-top:1px solid #777;display:none;">
            <div style="background-color:#353535;color:#aaa;font-weight:bold;text-align:center;"><a class="wm-selector selected" href="javascript:void(0)">COLLECTED BY</a></div>
    <div style="padding:3px;position:relative;">
            <div style="display:inline-block;vertical-align:top;width:50%;">
			<span class="c-logo" style="background-image:url(https://archive.org/services/img/alexacrawls);"></span>
		Organization: <a style="color:#33f;" href="https://archive.org/details/alexacrawls" target="_new"><span class="wm-title">Alexa Crawls</span></a>
		<div style="max-height:75px;overflow:hidden;position:relative;">
	  <div style="position:absolute;top:0;left:0;width:100%;height:75px;background:linear-gradient(to bottom,rgba(255,255,255,0) 0%,rgba(255,255,255,0) 90%,rgba(255,255,255,255) 100%);"></div>
	  Starting in 1996, <a href="http://www.alexa.com/">Alexa Internet</a> has been donating their crawl data to the Internet Archive.  Flowing in every day, these data are added to the <a href="http://web.archive.org/">Wayback Machine</a> after an embargo period.
	</div>
	      </div>
      <div style="display:inline-block;vertical-align:top;width:49%;">
			<span class="c-logo" style="background-image:url(https://archive.org/services/img/alexa_ei)"></span>
		<div>Collection: <a style="color:#33f;" href="https://archive.org/details/alexa_ei" target="_new"><span class="wm-title">Alexa Crawl EI</span></a></div>
		<div style="max-height:75px;overflow:hidden;position:relative;">
	  <div style="position:absolute;top:0;left:0;width:100%;height:75px;background:linear-gradient(to bottom,rgba(255,255,255,0) 0%,rgba(255,255,255,0) 90%,rgba(255,255,255,255) 100%);"></div>
	  Crawl EI from Alexa Internet.  This data is currently not publicly accessible.
	</div>
	      </div>
    </div></div></div></div></div><script type="text/javascript">
__wm.bt(550,27,25,2,"web","http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html","2006-04-26",1996);
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

<div class="header-wrapper">
  <img src="/web/20060426135849im_/http://www.ecclestoad.co.uk:80/i/eccles_and_toad.gif" alt="Eccles &amp; Toad" align="left">

    <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/">home</a>
~ <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/">blog</a>
~ <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/perl/">perl</a>
~ <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/projects/">projects</a>
~ <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/employ-me/">employ me</a>

  <br>

  You are here: <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/">home</a> &gt; <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/">blog</a> &gt; <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/2005">2005</a> &gt; <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/2005/05">05</a> &gt; <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/2005/05/27">27</a> &gt; <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/2005/05/27/obfuscation_as_a_learning_tool.html">Obfuscation as a learning tool.</a>
  <br clear="all">

</div>

<div class="google-ads">
<script type="text/javascript"><!--
google_ad_client = "pub-7132662714982338";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_ad_type = "text";
google_ad_channel ="";
google_color_border = "CCCCCC";
google_color_bg = "FFFFFF";
google_color_link = "999999";
google_color_url = "99CCFF";
google_color_text = "999999";
//--></script>
<script type="text/javascript" src="https://web.archive.org/web/20060426135849js_/http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>


<h1>Obfuscation as a learning tool.</h1>

<p>A couple of days ago I posted an obfuscation that solves <a href="/web/20060426135849/http://www.ecclestoad.co.uk:80/blog/2005/05/25/sudoku_solver_in_four_lines.html">sudoku puzzles in four lines</a> of Perl. To compress the code down to this level required quite a few dirty little tricks which would have no place in production code. Here I am going to postmortem the obfu and point out what there is to learn from it.</p>

<p>First the code as an obfu:</p>

<pre>
$a=8;$G{int(++$a/9).$a%9+1}=$_ for split//,&lt;&gt;;@A=1..9;sub c{int(($_[0]-1
)/3)*3}sub G{for$y(@A){for$x(@A){$p=$t=$G{my$c=$y.$x}&amp;&next;$t.=$G{$_.$x
}.$G{$y.$_}for@A;for$f(1..3){$t.=$G{c($y)+$f.c($x)+$_}for 1..3}G($G{$c}=
$_)&amp;&return; for grep$t!~m/$_/,@A;return$G{$c}=0}}die map{$G{$_}}9..99}G

</pre>
<p>And then tidied up by <tt>perltidy</tt>:</p>

<pre>
$a = 8;
$G{ int( ++$a / 9 ) . $a % 9 + 1 } = $_ for split //, &lt;&gt;;
@A = 1 .. 9;

sub c {
    int( ( $_[0] - 1 ) / 3 ) * 3;
}

sub G {
    for $y (@A) {
        for $x (@A) {
            $p = $t = $G{ my $c = $y . $x } &amp;&amp; next;
            $t .= $G{ $_ . $x } . $G{ $y . $_ } for @A;
            for $f ( 1 .. 3 ) { $t .= $G{ c($y) + $f . c($x) + $_ } for 1 .. 3 }
            G( $G{$c} = $_ ) &amp;&amp; return for grep $t !~ m/$_/, @A;
            return $G{$c} = 0;
        }
    }
    die map { $G{$_} } 9 .. 99;
}
G
</pre>

<p>Now I will run through the code explaining what each bit does and
musing about it.</p>

<pre>
$a = 8;
$G{ int( ++$a / 9 ) . $a % 9 + 1 } = $_ for split //, &lt;&gt;;
</pre>

<p>This code takes the input and builds a hash. The hash <tt>%G</tt>
is keyed on two numbers, such as '23' or '39'. This number is the
(y,x) coordinate on the sudoku grid, with the origin in the top
left. I used (y,x), rather than (x,y), as it allowed me to print the
grid out later on more easily.</p>

<p>
The creation of the key is quite interesting as we are numbering the
values coming in on the list in a sort of base 9. Think about the
change in numbers as you go off the first row and onto the second: 17,
18, 19, 21, 22, 23. As you can see it needs to jump from 19 to 21. The
y coordinate is done by throwing away the fractional part of a
division, the x coordinate is obtained using a modulus. The increasing
value to work with is provided by <tt>$a</tt> which starts out as '8'
and then is pre-incremented during the creation of the key. 
</p>

<pre>
@A = 1 .. 9;
</pre>

<p>Simplicity itself. <tt>@A</tt> is just an array of 1 to 9. If you
look in the rest of the code there are many times when I needed to run
from 1 to 9 and so as a space saver it was worth creating this
array.</p>

<pre>
sub c {
    int( ( $_[0] - 1 ) / 3 ) * 3;
}
</pre>

<p>This is a helper function that is used later on when finding which
numbers are currently in the block that we are looking at. It is
passed a single digit from 1 to 9. It returns 0, 3 or 6 for 1..3, 4..6
or 7..9. See later for how the return value is used.</p>

<pre>
sub G {
</pre>

<p>Create a sub routine <tt>G</tt>. This is the meat of the obfu and
most action occurs in here. The basic idea is to find the first square
on the grid that does not have a value. Then find all the possible
numbers that could go in. For each number put it in and recurse. If we
reach the end of the grid exit, otherwise try the next value. If there
are no more values to try backup to previous squares.</p>

<pre>
    for $y (@A) {
        for $x (@A) {
</pre>

<p>The heart of the routine is two loops, both from 1..9. This gives
us the coordinates of the square in the grid that we are working on.</p>

<pre>
            $p = $t = $G{ my $c = $y . $x } &amp;&amp; next;
</pre>

<p>Several things happen in this line. The most important one is to
see if there is a number in the square. As all empty squares are set
to 0 (false) this can be done with a simple boolean test. If there is
a number then <tt>$G{'yx'}</tt> is true which causes the <tt>next</tt>
to get called. This is taking advantage of Perl lazy evaluation of the
terms, ie. if the first test fails (there is no number) then there is
no need to evaluate the second test, the <tt>next</tt>.</p>

<p>In the interests of cramming code in there are a few other things
going on. Firstly a variable <tt>$c</tt> is set up containing the
current (y,x) location. This assignment happens inside the curly
braces of the hash. This works because the return value of an
assignment is the value assigned. This is also used to give initial
false values to <tt>$p</tt> and <tt>$t</tt> which are used later. The
values in <tt>$p</tt> and <tt>$t</tt> are always false as if it was
true then the loop would have jumped on.</p>

<pre>
            $t .= $G{ $_ . $x } . $G{ $y . $_ } for @A;
</pre>

<p>Finally we start to actually determine what numbers could go into
this square. The <tt>$t</tt> string is appended with the numbers that
are already taken (t is for taken). This is done for both the current
row and the current column in one statement.</p>

<pre>
            for $f ( 1 .. 3 ) { $t .= $G{ c($y) + $f . c($x) + $_ } for 1 .. 3 }
</pre>

<p>This double loop appends the numbers that are taken in the current
block onto <tt>$t</tt>. There are two variables floating around,
<tt>$f</tt> and <tt>$_</tt> which both run from 1..3. These are added
to the return value from the <tt>c</tt> subroutine discussed earlier
which results in the squares in the current grid being selected.</p>

<p>The funny use of two <tt>for</tt> loops in this way is to save space.</p>

<pre>
            G( $G{$c} = $_ ) &amp;&amp; return for grep $t !~ m/$_/, @A;
</pre>

<p>There are several things going on here. There is a loop over the
possible number that could go into the square: <tt>for grep $t !~
m/$_/, @A</tt>. As <tt>$t</tt> contains the numbers that are taken the
<tt>grep</tt> only returns the numbers from 1 to 9 that are not taken,
ie possible values.</p>

<p>For each possible number <tt>G( $G{$c} = $_ ) &amp;&amp; return</tt> is
executed. This sets the current square to the possible value. It then
recurses into <tt>G</tt>. If the return value is true then it
returns. In fact it returns true as unless specifically given a value
<tt>return</tt> will return whatever is in <tt>$_</tt>, which as it
happens was just set to the return value from <tt>G</tt>. This will
always be true for the <tt>return</tt> to get called and so true is
always returned.</p>

<p>You might wonder why the current square is assigned its value as an
argument to the subroutine <tt>G</tt>? The answer is that it saves one
character doing it this way. Compare <tt>G( $G{$c} = $_ )</tt> to
<tt>$G{$c} = $_, G()</tt>. As <tt>G</tt> does nothing with arguments
it is passed this is fine.
</p>

<pre>
            return $G{$c} = 0;
        }
    }
</pre>

<p>If the code did not return above then it should now. If we reach
this stage then every possible number for this square was tried and
none of them led to a solution of the sudoku. We want to set the
current square back to false and the allow the code to try changing
some previous numbers to see if they lead to a solution. Again the
return value from an assignment is used as a space saver.</p>

<pre>
    die map { $G{$_} } 9 .. 99;
}
</pre>

<p>This is dirty. I needed to shave off a couple of characters to
get into four lines and so I did this. If we reach this point then the
two <tt>for</tt> loops for <tt>$x</tt> and <tt>$y</tt> have reached
the end. What has has happened is that the final square has been
assigned a number. The subroutine has recursed and the two
<tt>for</tt> loops have run and <tt>next</tt> has been called for
every square as they all have numbers in them. Hence we end up here. To
save those last few characters I used <tt>die</tt> instead of
<tt>print</tt>. Horrible.</p>

<p>There is no need in the the map to worry about the values in
<tt>G</tt> for keys such as 10 or 20 that have no values. They simply
result in undefs being printed which produces no errors as <tt>use
warnings</tt> has not been specified.</p>

<pre>
G
</pre>


<p>So here we are at the end of the code. All we need to do now is run
<tt>G</tt> for the first time.</p>

<p>Rather interestingly I have spotted a space saver writing this
post. There is a variable <tt>$p</tt> that was set to false but never
actually gets used. It used to be used for possible values that could
go into the square but became unneeded due to changes. However I
forgot it in there. Bug fixing by code reading in action.</p>

<p>Another space saver is that as the code dies when a solution is
found there is no need to return as the code would already have
died. This means that another line can be shortened:</p>

<pre>
            G( $G{$c} = $_ ) &amp;&amp; return for grep $t !~ m/$_/, @A; # before
            G( $G{$c} = $_ ) for grep $t !~ m/$_/, @A;           # after
</pre>

<p>This means that the <tt>die</tt> can be tidied up a bit and we can
even format the output:</p>

<pre>
    die map { $G{$_} } 9 .. 99;             # before
    die map { $G{$_} || "\n" } 9 .. 100;    # after
</pre>

<p>The new, better, shorter obfu:</p>

<pre>
$a=8;$G{int(++$a/9).$a%9+1}=$_ for split//,&lt;&gt;;@A=1..9;sub c{int(($_[0]-1
)/3)*3}sub G{for$y(@A){for$x(@A){$t=$G{my$c=$y.$x}&amp;&next;$t.=$G{$_.$x}.
$G{$y.$_}for@A;for$f(1..3){$t.=$G{c($y)+$f.c($x)+$_}for 1..3}G($G{$c}=$_
)for grep$t!~m/$_/,@A;return$G{$c}=0}}die map{$G{$_}||"\n"}9..100}G
</pre>

<p>I hope that you will agree that even though there are only four
lines of code here there is plenty to think about. Not all of it is
'good' code, in fact most of it is very bad code. However the
artificial constraint of four lines leads to some interesting
techniques that take advantages of some of the more esoteric parts of
the language.</p>


<div class="footer-wrapper">
  &copy; 2005 Eccles &amp; Toad ~
  <a class="grey" href="https://web.archive.org/web/20060426135849/mailto:evdb@ecclestoad.co.uk">evdb@ecclestoad.co.uk</a>
</div>

  </body>
</html>

